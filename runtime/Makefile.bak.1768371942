SHELL := /bin/bash
.DEFAULT_GOAL := help

# Repo paths
DEMO_DIR := ai-firewall-demo

PY := python3
PIP := pip3

PORT ?= 5000

# ----- Helpers -----
define banner
	@echo ""
	@echo "============================================================"
	@echo "$(1)"
	@echo "============================================================"
endef

help: ## Show commands
	@echo ""
	@echo "PrivateVault AI Firewall - Make Targets"
	@echo ""
	@grep -E '^[a-zA-Z0-9_-]+:.*?## ' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-22s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Examples:"
	@echo "  make install"
	@echo "  make test"
	@echo "  make verify"
	@echo "  make start PORT=5001"
	@echo "  make docker-up"
	@echo ""

# ----- Environment -----
install: ## Install python dependencies for ai-firewall-demo
	$(call banner,"ğŸ“¦ Installing dependencies")
	cd $(DEMO_DIR) && $(PIP) install -r requirements.txt

env: ## Create .env from example if missing
	$(call banner,"ğŸ” Ensuring .env exists")
	cd $(DEMO_DIR) && test -f .env || cp .env.example .env
	@echo "âœ… .env ready at $(DEMO_DIR)/.env"

# ----- Lint / formatting (optional) -----
lint: ## Basic syntax checks
	$(call banner,"ğŸ” Lint (syntax check)")
	cd $(DEMO_DIR) && $(PY) -m py_compile *.py
	@echo "âœ… Python compile OK"

# ----- Unit tests / feature tests -----
test-core: ## Test core firewall features
	$(call banner,"ğŸ”¥ TEST: Core firewall")
	cd $(DEMO_DIR) && $(PY) ai_firewall_core.py

test-tools: ## Test tool authorization + signing
	$(call banner,"ğŸ” TEST: Tool authorization")
	cd $(DEMO_DIR) && $(PY) tool_authorization.py

test-drift: ## Test drift detection fixed module
	$(call banner,"ğŸ“Š TEST: Drift detection")
	cd $(DEMO_DIR) && $(PY) drift_detection_fixed.py

test-ledger: ## Test decision ledger integrity
	$(call banner,"ğŸ“ TEST: Decision ledger")
	cd $(DEMO_DIR) && $(PY) decision_ledger.py

test-orchestrator: ## Test full orchestration (E2E)
	$(call banner,"ğŸ¯ TEST: Orchestrator E2E")
	cd $(DEMO_DIR) && $(PY) ai_firewall_orchestrator.py

test-orchestrator-dual: ## Test dual drift orchestrator (shadow vs prod)
	$(call banner,"ğŸ¯ TEST: Dual drift orchestrator")
	cd $(DEMO_DIR) && $(PY) ai_firewall_orchestrator_dual_drift.py

test-api: ## Run API tests (requires API running)
	$(call banner,"ğŸ§ª TEST: API client")
	cd $(DEMO_DIR) && $(PY) test_api.py

test: test-core test-tools test-drift test-ledger test-orchestrator ## Run all module tests (non-API)
	$(call banner,"âœ… ALL TESTS COMPLETE")

verify: lint test ## Verify build: lint + tests

# ----- Run API -----
start: env ## Start Flask API locally (PORT=5000 by default)
	$(call banner,"ğŸš€ Starting API on port $(PORT)")
	cd $(DEMO_DIR) && PORT=$(PORT) ./start_api.sh

start-bg: env ## Start API in background, logs to ai-firewall-demo/api.log
	$(call banner,"ğŸš€ Starting API in background on port $(PORT)")
	cd $(DEMO_DIR) && nohup env PORT=$(PORT) ./start_api.sh > api.log 2>&1 &
	@sleep 2
	@echo "âœ… API started. Tail logs:"
	@echo "   tail -f $(DEMO_DIR)/api.log"

stop: ## Stop API on PORT (default 5000)
	$(call banner,"ğŸ›‘ Stopping API on port $(PORT)")
	-@sudo fuser -k $(PORT)/tcp 2>/dev/null || true
	@echo "âœ… Stopped (if it was running)"

curl-health: ## Curl health endpoint
	$(call banner,"ğŸ¥ Health check")
	@curl -s http://localhost:$(PORT)/health | $(PY) -m json.tool

# ----- Docker -----
docker-build: ## Build docker image
	$(call banner,"ğŸ³ Docker build")
	cd $(DEMO_DIR) && docker build -t privatevault-ai-firewall:local .

docker-up: ## Start docker compose stack
	$(call banner,"ğŸ³ Docker compose up")
	cd $(DEMO_DIR) && docker-compose up -d
	@echo "âœ… Running containers:"
	cd $(DEMO_DIR) && docker-compose ps

docker-down: ## Stop docker compose stack
	$(call banner,"ğŸ³ Docker compose down")
	cd $(DEMO_DIR) && docker-compose down

# ----- Cleanup -----
clean: ## Remove python caches + logs
	$(call banner,"ğŸ§¹ Cleanup")
	@find . -type d -name "__pycache__" -prune -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@rm -f $(DEMO_DIR)/*.log $(DEMO_DIR)/*.json $(DEMO_DIR)/*.jsonl 2>/dev/null || true
	@echo "âœ… Clean complete"

# ----- Full demo flows -----
run: verify ## Verify + run dual orchestrator (best demo)
	$(call banner,"ğŸ RUN: Verify then Dual Drift Demo")
	cd $(DEMO_DIR) && $(PY) ai_firewall_orchestrator_dual_drift.py

demo: ## Quick demo (core + tool + drift)
	$(call banner,"ğŸ¬ DEMO")
	@$(MAKE) test-core
	@$(MAKE) test-tools
	@$(MAKE) test-drift
