services:
  postgres:
    image: postgres:15-alpine
    container_name: pvkb-postgres
    environment:
      POSTGRES_DB: privatevault
      POSTGRES_USER: pvuser
      POSTGRES_PASSWORD: pvpass123
    ports:
    - 5432:5432
    volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./migrations:/docker-entrypoint-initdb.d
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: pvkb-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
    - 2181:2181
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: pvkb-kafka
    depends_on:
    - zookeeper
    ports:
    - 9092:9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
  license-service:
    build: ./services/license-service
    container_name: pvkb-license-service
    ports:
    - 3001:3001
    environment:
      DATABASE_URL: postgresql://pvuser:pvpass123@postgres:5432/privatevault
      JWT_SECRET: dev-jwt-secret-change-me
      PORT: 3001
    depends_on:
    - postgres
  usage-tracker:
    build: ./services/usage-tracker
    container_name: pvkb-usage-tracker
    ports:
    - 3002:3002
    environment:
      DATABASE_URL: postgresql://pvuser:pvpass123@postgres:5432/privatevault
      KAFKA_BROKERS: kafka:9092
      SIGNING_KEY: dev-signing-key-change-me
      PORT: 3002
    depends_on:
    - postgres
    - kafka
  billing-service:
    build: ./services/billing-service
    container_name: pvkb-billing-service
    ports:
    - 3003:3003
    environment:
      DATABASE_URL: postgresql://pvuser:pvpass123@postgres:5432/privatevault
      STRIPE_SECRET_KEY: ''
      PORT: 3003
    depends_on:
    - postgres
  kb-service:
    build: ./services/kb-service
    ports:
    - 8081:8081
    environment:
      PORT: 8081
    depends_on:
    - postgres
  envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: pvkb-envoy
    ports:
    - 8080:8080
    - 9901:9901
    volumes:
    - ./config/envoy/envoy.yaml:/etc/envoy/envoy.yaml
    depends_on:
    - opa
    - kb-service
  opa:
    image: openpolicyagent/opa:latest
    container_name: pvkb-opa
    command:
    - run
    - --server
    - --addr=0.0.0.0:8181
    - --set=plugins.envoy_ext_authz_grpc.addr=:9191
    - --set=plugins.envoy_ext_authz_grpc.path=envoy/authz/allow
    - --set=decision_logs.console=false
    - /policies
    volumes:
    - ./config/opa:/policies:ro
    ports:
    - 8181:8181
    - 9191:9191
volumes:
  postgres_data: null
